<div class="row">
    <div class="col-12">
        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
            <h4 class="mb-sm-0 font-size-18">Malware Pattern Scanner</h4>
             <div class="page-title-right">
                <ol class="breadcrumb m-0">
                    <li class="breadcrumb-item"><a href="/admin/security">Security</a></li>
                    <li class="breadcrumb-item active">Malware Scanner</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="alert alert-info">
                    <strong>Deep Scan:</strong> This scanner analyzes file contents for suspicious PHP functions (e.g., <code>eval</code>, <code>base64_decode</code>, <code>shell_exec</code>) often used in webshells and backdoors.
                </div>
                
                <div class="text-center mb-4">
                    <button id="btn-scan" class="btn btn-primary btn-lg" onclick="runScan()">
                        <i class="ri-radar-line align-middle me-1"></i> Start Deep Scan
                    </button>
                    <p class="text-muted mt-2">Scan may take a few seconds depending on project size.</p>
                </div>

                <div id="scan-loading" class="text-center" style="display: none;">
                    <div class="spinner-border text-primary m-1" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>

                <div id="scan-results" style="display: none;">
                    <h5 class="card-title">Scan Results</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">File</th>
                                    <th>Detected Pattern</th>
                                    <th>Line</th>
                                    <th>Snippet</th>
                                </tr>
                            </thead>
                            <tbody id="scan-results-body">
                                <!-- Results here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="no-threats" class="alert alert-success mt-3" style="display: none;">
                        <i class="ri-check-double-line me-1"></i> No suspicious patterns detected.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
async function runScan() {
    const btn = document.getElementById('btn-scan');
    const loading = document.getElementById('scan-loading');
    const resultsArea = document.getElementById('scan-results');
    const tbody = document.getElementById('scan-results-body');
    const noThreats = document.getElementById('no-threats');

    btn.disabled = true;
    loading.style.display = 'block';
    resultsArea.style.display = 'none';
    tbody.innerHTML = '';
    noThreats.style.display = 'none';

    try {
        const response = await fetch('/api/security/malware/scan', { method: 'POST' });
        const data = await response.json();

        loading.style.display = 'none';
        btn.disabled = false;
        resultsArea.style.display = 'block';

        if (data.success) {
            if (data.data.results.length === 0) {
                noThreats.style.display = 'block';
            } else {
                data.data.results.forEach(file => {
                    file.threats.forEach(threat => {
                        const row = `
                            <tr>
                                <td class="text-break"><code>${file.file}</code></td>
                                <td><span class="badge bg-danger">${threat.pattern}</span></td>
                                <td>${threat.line}</td>
                                <td><code>${escapeHtml(threat.snippet)}</code></td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                });
            }
        } else {
            alert('Scan Failed: ' + data.message);
        }
    } catch (e) {
        loading.style.display = 'none';
        btn.disabled = false;
        alert('Scan Error: ' + e.message);
    }
}

function escapeHtml(text) {
    if (!text) return '';
    return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}
</script>
